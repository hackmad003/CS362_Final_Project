/*
 * Michael ELGOO UNO R3 
 * LCD Display Controller - Arduino UNO R3
 * Receives joystick data via Serial from Back Car
 * Displays on TWO 16x2 I2C LCDs (License Plates)


  ABSTRCT: This project implements a four-wheel drive RC car using four
  Arduino microcontrollers with Bluetooth communication and software 
  differential steering. Team possesses three Arduino UNO R4 Wi-Fi 
  boards, where two manage two motors each, and one serves as the 
  wireless remote controlling the carâ€™s functions. 
  The system features independent yet synchronized front and rear
  motor control through L298N Drivers. While one ELGOO UNO R3 
  configures (2) 16x2 LCD displays as license plates. 
  The car circuit is powered with 18650 batteries, and the remote
  circuit is powered by a bread board battery pack. Originality 
  includes differential steering and an extended 14-inch chassis. (100)



  HARDWARE:



  GROUP NUMBER: 50

  ORIGINALITY: 
  Original Chassis Construct 
  Original Motor Algorithms
  Original Circuit Topology
  Original Project Design
  ETC

  Ahmad Awaidah (aawai) (aawai@uic.edu) Arduino UNO R4 Wi-Fi
  2 DEVICES: L298N Driver, 2 DC Motors
  COMMUNICATION: BLE, Serial

  Michael Nguyen (mnguy37) (mnguy37@uic.edu) ELGOO UNO R3
  2 DEVICES: 2 LCD Displays
  COMMUNICATION: Serial

  Mike Vinanzaca (mvina2) (mvina2@uic.edu) Arduino UNO R4 Wi-Fi
  2 DEVICES: L298N Driver, 2 DC Motors
  COMMUNICATION: BLE

  Patrick Thomas (pthom29) (pthom29@uic.edu) Arduino UNO R4 Wi-Fi
  2 DEVICES: LED Light, Joystick
  COMMUNICATION: BLE



 */


// REQUIRED LIBRARIES //
#include <Wire.h>
#include <LiquidCrystal_I2C.h>

// Two LCDs with different I2C addresses
LiquidCrystal_I2C lcd1(0x27, 16, 2); // Front LCD
LiquidCrystal_I2C lcd2(0x3F, 16, 2); // Back LCD

//////////////////////////
// JOYSTICK DATA STRUCT //
//////////////////////////
struct JoystickData {
  int16_t x;
  int16_t y;
};

// STRUCT OBJECT //
JoystickData data;

// T?F VAR //
unsigned long lastUpdate = 0;


////////////
// SET UP //
////////////
void setup() {
  Serial.begin(9600);
  
  // Initialize both LCDs
  lcd1.init();
  lcd1.backlight();
  lcd2.init();
  lcd2.backlight();
  
  // Startup message
  lcd1.clear();
  lcd1.setCursor(0, 0);
  lcd1.print("  CS362 RC CAR  ");
  lcd1.setCursor(0, 1);
  lcd1.print("   FRONT PLATE  ");
  
  lcd2.clear();
  lcd2.setCursor(0, 0);
  lcd2.print("  CS362 RC CAR  ");
  lcd2.setCursor(0, 1);
  lcd2.print("   REAR PLATE   ");
  
  delay(2000);
  lcd1.clear();
  lcd2.clear();
}


//////////
// LOOP //
//////////
void loop() {
  // Check if serial data available
  if (Serial.available() >= sizeof(JoystickData)) {
    // Read the data struct
    Serial.readBytes((char*)&data, sizeof(JoystickData));
    lastUpdate = millis();
    
    updateDisplays();
  }
  
  // If no data for 2 seconds, show "WAITING"
  if (millis() - lastUpdate > 2000) {
    showWaitingMessage();
    delay(500);
  }
}

/////////////////////
// UPDATE DISPLAYS //
/////////////////////
void updateDisplays() {
  // FRONT LCD - Show direction and coordinates
  lcd1.clear();
  lcd1.setCursor(0, 0);
  lcd1.print("DIR: ");
  lcd1.print(getDirection());
  
  lcd1.setCursor(0, 1);
  lcd1.print("X:");
  lcd1.print(data.x);
  lcd1.print(" Y:");
  lcd1.print(data.y);
  
  // BACK LCD - Show license plate or status
  lcd2.clear();
  lcd2.setCursor(0, 0);
  lcd2.print("  UIC-CS362-24  ");
  lcd2.setCursor(0, 1);
  lcd2.print("  ROBOTICS R4  ");
}

///////////////////
// GET DIRECTION //
///////////////////
String getDirection() {
  int x = data.x;
  int y = data.y;
  
  // Deadzone
  if (x > 450 && x < 570 && y > 450 && y < 570) {
    return "STOP    ";
  }
  
  if (y > 600) return "FORWARD ";
  else if (y < 400) return "BACKWARD";
  else if (x < 400) return "LEFT    ";
  else if (x > 600) return "RIGHT   ";
  
  return "UNKNOWN ";
}

//////////////////////////
// SHOW WAITING MESSAGE //
//////////////////////////
void showWaitingMessage() {
  lcd1.clear();
  lcd1.setCursor(0, 0);
  lcd1.print("  WAITING FOR   ");
  lcd1.setCursor(0, 1);
  lcd1.print("    SIGNAL...   ");
  
  lcd2.clear();
  lcd2.setCursor(0, 0);
  lcd2.print("   NO REMOTE    ");
  lcd2.setCursor(0, 1);
  lcd2.print("   CONNECTION   ");
}


/////////
// EOF //
/////////
