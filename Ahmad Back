
/*
 * RC Car - BACK WHEELS + SERIAL TO R3
 * Receives BLE commands AND forwards to R3 for LCD display
 */
#include <ArduinoBLE.h>

// Motor Pins
#define ENA 5
#define IN1 2
#define IN2 3
#define IN3 4
#define IN4 6
#define ENB 9

// BACK CAR UUIDs
BLEService backCarService("19B10000-E8F2-537E-4F6C-D104768A1215");
BLECharacteristic backCommandChar("19B10001-E8F2-537E-4F6C-D104768A1216", BLERead | BLEWrite, 4);

struct JoystickData {
  int16_t x;
  int16_t y;
};
JoystickData receivedData;

void setup() {
  Serial.begin(9600); // Serial to R3
  
  pinMode(ENA, OUTPUT); pinMode(ENB, OUTPUT);
  pinMode(IN1, OUTPUT); pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT); pinMode(IN4, OUTPUT);
  stopMotors();

  if (!BLE.begin()) {
    while (1);
  }

  BLE.setLocalName("BACK_CAR_R4");
  BLE.setAdvertisedService(backCarService);
  backCarService.addCharacteristic(backCommandChar);
  BLE.addService(backCarService);
  
  BLE.advertise();
}

void loop() {
  BLEDevice central = BLE.central();

  if (central) {
    while (central.connected()) {
      if (backCommandChar.written()) {
        backCommandChar.readValue(&receivedData, sizeof(receivedData));
        
        // Control motors
        controlMotors(receivedData.x, receivedData.y);
        
        // SEND DATA TO R3 VIA SERIAL
        Serial.write((byte*)&receivedData, sizeof(receivedData));
      }
    }
    
    stopMotors();
  }
}

void controlMotors(int x, int y) {
  if (x > 450 && x < 570 && y > 450 && y < 570) {
    stopMotors();
    return;
  }

  //if (y > 600) move(HIGH, LOW, HIGH, LOW, 150);      
  //else if (y < 400) move(LOW, HIGH, LOW, HIGH, 150);  
  //else if (x < 400) move(LOW, HIGH, HIGH, LOW, 150);  
  //else if (x > 600) move(HIGH, LOW, LOW, HIGH, 150);  
  
  if (y > 600) move(HIGH, LOW, HIGH, LOW, 150);      // Forward - SAME
else if (y < 400) move(LOW, HIGH, LOW, HIGH, 150);  // Backward - SAME
else if (x < 400) move(HIGH, LOW, LOW, HIGH, 150);  // Left - REVERSED ⚡
else if (x > 600) move(LOW, HIGH, HIGH, LOW, 150);  // Right - REVERSED ⚡

}

void move(int n1, int n2, int n3, int n4, int speed) {
  digitalWrite(IN1, n1); digitalWrite(IN2, n2);
  digitalWrite(IN3, n3); digitalWrite(IN4, n4);
  analogWrite(ENA, speed); analogWrite(ENB, speed);
}

void stopMotors() {
  digitalWrite(IN1, LOW); digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW); digitalWrite(IN4, LOW);
  analogWrite(ENA, 0); analogWrite(ENB, 0);
}
